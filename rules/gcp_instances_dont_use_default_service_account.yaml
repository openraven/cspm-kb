id: ab8866f8-e24e-4e2c-bca9-344834d1b817
ruleId: gcp_003
type: asset
ruleName: >
  Ensure that instances are not configured to use the default service account
description: >
  It is recommended to configure your instance to not use the default Compute Engine
  service account because it has the Editor role on the project.
severity: high
enabled: true
sql: >
  SELECT asset_id
  FROM
    (SELECT asset_id,
            jsonb_array_elements(jsonb_array_elements(supplementary_configuration->'instances')->'serviceAccounts') AS service_accounts
     FROM assets
     WHERE resource_type = 'GCP::ComputeEngine::Zone') get_email
  WHERE service_accounts->>'email' ILIKE '%-compute@developer.gserviceaccount.com'
remediation: >
  From Console:
    1. Go to the VM instances page by visiting:
      https://console.cloud.google.com/compute/instances.
    2. Click on the instance name to go to its VM instance details page.
    3. Click STOP and then click EDIT .
    4. Under the section Service Account , select a service account other than the default
      Compute Engine service account. You may first need to create a new service
      account.
    5. Click Save and then click START .
  From Command Line:
    1. Stop the instance:
      gcloud compute instances stop INSTANCE_NAME
    2. Update the instance:
      gcloud compute instances set-service-account INSTANCE_NAME --service-account=SERVICE_ACCOUNT
    3. Restart the instance:
      gcloud compute instances start INSTANCE_NAME
# remediationDocURLs:
# - https://docs.openraven.com/remediations/ensure_instances_dont_use_default_service_account
version: 0.1.3
