ruleId: aws-iam-and-security-botnet-access-permitted
type: asset
ruleName: >
  Security group allows outbound access to known botnet C&C addresses
description: >
  Security group ingress and egress rules should be locked down to the minimal set of permitted IP
  ranges.  This rule checks that security groups do not allow IP egress to known botnet command and control
  IP addresses.
severity: medium
enabled: false
sql: >
  SELECT arn, resourceId, configuration
  FROM ${magpie_schema}.awsec2securitygroup;
eval: >
  import json
  cnc_ips = {
    # https://exchange.xforce.ibmcloud.com/collection/Botnet-Command-and-Control-Servers-7ac6c4578facafa0de50b72e7bf8f8c4
    '131.253.18.12',
    '187.20.38.214',
    '217.147.169.242',
    '91.200.14.139',
    '217.23.5.57',
    '5.254.98.54',
    '5.61.39.14',
    '50.17.189.198',
    '50.21.187.135',
    '50.22.86.10',
    '50.23.98.194',
    '50.62.235.1',
    '50.62.31.207',
    '50.63.56.47',
    '50.87.146.115',
    '50.87.151.146',
    '50.87.153.96',
    '50.87.18.127',
    '50.87.72.219',
    '50.97.234.2',
    '52.10.128.168',
    '52.207.234.89',
    '54.209.159.227',
    '54.218.45.67',
    '54.228.191.94',
    '54.236.134.245',
    '54.239.172.114',
    '54.248.126.242',
    '54.72.9.51',
    '58.215.169.42',
    '58.215.240.96',
    '58.55.127.16',
    '59.32.213.195',
    '60.250.76.52',
    '61.139.126.15',
    '61.147.75.89',
    '61.158.145.141',
    '61.178.85.177',
    '61.19.251.27',
    '61.57.227.5',
    '41.207.222.252',
    '101.0.89.3',
    '101.200.81.187',
    '103.19.89.118',
    '103.230.84.239',
    '103.241.0.100',
    '103.26.128.84',
    '103.4.52.150',
    '103.7.59.135',
    '107.191.46.4',
    '109.127.8.242',
    '109.229.210.250',
    '109.229.36.65',
    '113.29.230.24',
    '116.193.77.118',
    '120.25.63.2',
    '120.31.134.133',
    '120.63.157.195',
    '123.30.129.179',
    '124.110.195.160',
    '128.210.157.251',
    '149.202.242.81',
    '151.80.52.45',
    '151.80.52.47',
    '151.97.190.239',
    '157.7.170.62',
    '160.97.52.229',
    '162.223.94.56',
    '177.4.23.159',
    '180.182.234.200',
    '185.25.117.49',
    '185.25.119.84',
    '185.35.138.22',
    '185.62.188.51',
    '185.99.133.163',
    '186.64.120.104',
    '187.174.252.247',
    '188.219.154.228',
    '188.226.141.142',
    '188.241.140.212',
    '188.241.140.222',
    '188.241.140.224',
    '188.247.135.53',
    '188.247.135.58',
    '188.247.135.74',
    '188.247.135.99',
    '190.123.35.140',
    '190.123.35.141',
    '190.128.29.1',
    '190.15.192.25',
    '192.64.11.244',
    '192.99.148.26',
    '192.99.19.4',
    '193.107.17.145',
    '193.107.17.55',
    '193.107.17.56',
    '193.107.19.24',
    '193.107.19.244',
    '193.146.210.69',
    '193.189.117.56',
    '193.201.227.142',
    '194.109.64.131',
    '194.58.103.199',
    '194.58.56.45',
    '195.20.40.123',
    '195.20.41.233',
    '195.20.42.1',
    '195.20.44.100',
    '195.20.44.109',
    '195.20.46.116',
    '198.245.202.92',
    '199.187.129.193',
    '199.201.121.185',
    '199.7.234.100',
    '2.50.11.28',
    '201.149.83.183',
    '202.144.144.195',
    '202.191.62.226',
    '202.29.22.38',
    '202.29.230.198',
    '202.67.13.107',
    '202.9.36.111',
    '203.170.193.23',
    '209.164.84.70',
    '210.211.108.215',
    '210.4.76.221',
    '212.44.64.202',
    '213.147.67.20',
    '216.176.100.240',
    '216.215.112.149',
    '217.12.202.85',
    '222.29.197.232',
    '23.113.113.105',
    '23.94.5.119',
    '23.96.196.120',
    '24.148.217.188',
    '24.172.94.180',
    '24.204.49.244',
    '27.131.149.102',
    '27.254.55.11',
    '31.131.139.42',
    '31.131.251.33',
    '31.134.100.179',
    '31.134.73.151',
    '31.14.134.47',
    '31.222.155.254',
    '31.23.128.204',
    '31.23.80.184',
    '31.28.103.254',
    '31.41.44.45',
    '31.42.172.36',
    '31.7.63.146',
    '37.123.99.188',
    '37.128.132.96',
    '37.139.30.95',
    '37.140.195.177',
    '37.143.11.189',
    '37.229.126.164',
    '37.46.131.153',
    '37.46.135.204',
    '37.48.125.119',
    '37.57.177.15',
    '37.58.112.101',
    '37.59.61.29',
    '37.99.146.27',
    '38.64.199.113',
    '38.64.199.33',
    '41.144.68.21',
    '41.189.45.166',
    '41.189.52.14',
    '41.189.53.94',
    '41.202.71.27',
    '41.202.78.237',
    '41.202.90.185',
    '41.207.11.79',
    '41.207.2.186',
    '41.207.203.238',
    '41.207.220.170',
    '41.207.220.57',
    '41.207.24.201',
    '41.207.64.49',
    '41.38.18.230',
    '41.66.35.238',
    '41.66.39.42',
    '41.79.173.47',
    '41.86.46.245',
    '42.117.2.85',
    '45.124.65.51',
    '45.127.92.179',
    '45.46.51.81',
    '45.55.136.31',
    '46.151.52.191',
    '46.151.52.61',
    '46.16.200.133',
    '46.161.2.60',
    '46.161.40.102',
    '46.161.40.106',
    '46.165.222.231',
    '46.19.136.211',
    '46.22.128.133',
    '46.22.134.78',
    '46.31.43.57',
    '46.33.54.45',
    '46.4.150.111',
    '46.4.203.213',
    '5.100.249.215',
    '5.135.28.113',
    '5.139.154.42',
    '5.152.199.70',
    '5.152.201.19',
    '5.172.193.101',
    '5.187.0.137',
    '5.187.193.224',
    '5.187.4.183',
    '5.196.249.163',
    '5.206.225.104',
    '5.9.253.173',
    '5.9.82.18',
    '50.62.233.1',
    '52.39.53.151',
    '58.195.1.4',
    '59.157.4.2',
    '60.13.186.5',
    '60.241.184.209',
    '60.249.31.231',
    '61.14.209.167',
    '61.47.43.241',
    '62.76.191.108',
    '63.249.152.74',
    '63.250.54.134',
    '64.127.71.73',
    '64.182.215.68',
    '64.182.6.61',
    '64.76.19.244',
    '64.76.19.251',
    '64.85.233.8',
    '69.118.144.195',
    '69.144.171.44',
    '69.15.194.26',
    '69.23.87.56',
    '72.167.245.34',
    '72.230.82.80',
    '72.41.18.212',
    '73.72.208.195',
    '74.119.194.18',
    '74.62.209.104',
    '78.138.104.167',
    '78.46.222.241',
    '80.65.93.241',
    '81.177.180.101',
    '82.196.3.245',
    '83.15.254.242',
    '83.212.117.233',
    '83.69.233.121',
    '87.236.210.110',
    '87.236.210.124',
    '87.237.198.245',
    '87.246.143.242',
    '87.254.167.37',
    '89.40.181.101',
    '90.80.231.36',
    '91.108.176.118',
    '91.121.240.111',
    '91.121.240.97',
    '91.195.12.143',
    '91.201.155.96',
    '91.224.141.11',
    '91.236.213.74',
    '91.236.75.11',
    '92.53.119.248',
    '92.53.124.62',
    '93.171.205.12',
    '94.103.36.55',
    '95.211.153.134',
    '98.126.6.83',
    '98.131.185.136',
    '192.42.119.41',
    '23.254.203.51',
    '81.177.140.212',
    '212.83.166.45',
    '173.230.136.67',
    '173.224.218.25',
    '104.227.137.34',
    '137.74.254.64',
    '188.165.220.214',
    '85.143.221.180',
    '119.82.27.246',
    '194.88.246.7',
    '206.214.220.79',
    '104.236.2.253',
    '62.39.95.185',
    '209.97.168.52',
    # https://rules.emergingthreats.net/open/suricata/rules/botcc.rules
    '103.109.247.13',
    '103.109.247.9',
    '103.110.14.43',
    '103.12.160.164',
    '103.122.228.44',
    '103.124.145.98',
    '103.140.207.110',
    '103.150.68.124',
    '103.161.172.109',
    '103.164.180.66',
    '103.238.203.82',
    '103.248.217.234',
    '103.253.107.155',
    '103.253.107.156',
    '103.253.107.198',
    '103.253.145.28',
    '103.30.247.115',
    '103.30.247.116',
    '103.40.116.68',
    '103.42.57.18',
    '103.73.102.174',
    '103.75.201.2',
    '103.9.77.211',
    '104.168.154.79',
    '104.168.155.113',
    '104.168.155.129',
    '104.245.52.73',
    '104.248.178.90',
    '105.27.205.34',
    '106.243.129.116',
    '107.170.64.97',
    '108.55.14.158',
    '109.104.92.237',
    '109.74.50.71',
    '111.230.104.169',
    '111.235.66.83',
    '113.160.132.237',
    '113.160.37.196',
    '114.207.112.77',
    '115.68.220.48',
    '116.203.25.236',
    '116.212.152.225',
    '118.42.135.173',
    '119.202.8.249',
    '121.199.35.69',
    '123.206.58.135',
    '1.234.20.244',
    '1.234.21.73',
    '125.234.128.250',
    '128.201.76.252',
    '131.100.24.199',
    '131.100.24.217',
    '131.100.24.231',
    '134.209.182.12',
    '137.74.112.43',
    '138.121.91.136',
    '139.162.202.74',
    '139.59.124.65',
    '139.59.59.242',
    '142.11.214.93',
    '14.241.244.60',
    '142.4.219.173',
    '142.44.247.57',
    '142.93.181.37',
    '144.48.139.206',
    '144.76.1.150',
    '144.76.42.74',
    '147.91.31.1',
    '148.235.154.164',
    '148.251.238.52',
    '149.210.181.82',
    '150.95.20.209',
    '153.122.13.133',
    '153.126.165.175',
    '154.79.244.182',
    '154.79.245.158',
    '154.79.251.172',
    '158.106.98.110',
    '158.181.179.229',
    '158.69.118.130',
    '159.224.167.102',
    '159.8.59.82',
    '162.13.114.59',
    '162.144.127.197',
    '162.144.76.184',
    '162.214.106.107',
    '162.214.127.16',
    '162.214.188.105',
    '162.241.41.92',
    '163.172.217.74',
    '164.68.126.207',
    '165.22.28.242',
    '166.62.103.55',
    '167.172.119.42',
    '167.99.61.111',
    '170.238.117.187',
    '173.203.78.138',
    '173.212.243.155',
    '175.126.167.148',
    '176.31.117.84',
    '176.9.89.122',
    '177.185.32.10',
    '177.52.173.20',
    '177.67.137.111',
    '177.75.5.222',
    '177.87.0.7',
    '178.128.197.110',
    '178.128.23.9',
    '178.128.83.165',
    '178.134.47.166',
    '178.238.236.59',
    '178.254.22.25',
    '178.254.33.197',
    '178.33.13.40',
    '178.33.158.180',
    '178.79.147.66',
    '178.79.150.86',
    '179.189.229.254',
    '180.250.21.2',
    '180.250.21.5',
    '181.112.157.42',
    '181.114.215.239',
    '181.129.167.82',
    '181.143.251.154',
    '181.167.217.53',
    '18.195.23.231',
    '182.253.106.35',
    '182.253.210.130',
    '184.74.99.214',
    '185.143.48.16',
    '185.148.168.220',
    '185.148.168.25',
    '185.164.32.148',
    '185.184.25.235',
    '185.234.72.84',
    '185.56.175.122',
    '185.59.223.86',
    '185.9.187.10',
    '186.225.119.170',
    '186.235.48.8',
    '186.97.172.178',
    '187.19.167.233',
    '188.40.100.254',
    '189.206.78.155',
    '190.109.204.126',
    '190.144.10.242',
    '190.145.83.98',
    '190.183.237.119',
    '190.197.55.254',
    '190.61.43.241',
    '190.93.208.53',
    '192.163.233.216',
    '192.99.41.136',
    '193.47.240.8',
    '193.90.12.121',
    '195.210.28.233',
    '195.234.101.236',
    '195.8.114.137',
    '195.9.232.252',
    '195.9.84.106',
    '196.216.220.211',
    '196.216.59.174',
    '197.156.129.250',
    '198.1.115.153',
    '199.204.214.52',
    '200.236.218.62',
    '202.165.47.106',
    '202.29.60.34',
    '203.114.109.114',
    '203.176.138.46',
    '204.138.26.220',
    '204.174.223.210',
    '207.210.192.60',
    '207.58.132.19',
    '209.151.236.42',
    '209.20.87.138',
    '209.216.243.2',
    '209.44.106.71',
    '209.59.199.129',
    '209.89.76.47',
    '210.65.244.176',
    '210.65.244.182',
    '210.65.244.186',
    '210.65.244.187',
    '211.110.44.63',
    '212.227.94.31',
    '216.10.251.121',
    '216.108.227.55',
    '216.166.148.187',
    '216.177.161.118',
    '217.79.184.243',
    '220.82.64.198',
    '221.147.172.5',
    '222.124.16.74',
    '23.160.193.106',
    '24.162.214.166',
    '24.28.12.23',
    '31.207.89.74',
    '36.66.188.251',
    '36.67.97.127',
    '36.89.191.119',
    '36.89.193.181',
    '36.89.98.183',
    '37.187.115.122',
    '37.247.35.130',
    '37.247.35.137',
    '37.34.58.210',
    '37.59.103.148',
    '38.110.100.104',
    '38.110.100.219',
    '38.110.100.33',
    '38.110.100.64',
    '41.57.156.203',
    '41.77.185.182',
    '43.229.206.212',
    '43.229.206.214',
    '43.229.206.244',
    '43.252.158.104',
    '45.201.134.202',
    '45.234.248.154',
    '45.239.233.109',
    '45.33.94.33',
    '45.36.99.184',
    '45.40.132.219',
    '45.55.134.126',
    '45.58.56.12',
    '45.79.33.48',
    '45.79.91.89',
    '46.101.90.205',
    '46.209.140.220',
    '46.55.222.10',
    '46.99.175.149',
    '46.99.175.217',
    '46.99.188.223',
    '49.156.34.134',
    '49.248.217.170',
    '50.116.23.195',
    '50.116.54.215',
    '50.116.62.25',
    '50.249.212.98',
    '51.178.161.32',
    '5.152.175.57',
    '51.77.82.110',
    '5.182.210.132',
    '5.182.210.254',
    '51.91.105.97',
    '51.91.156.39',
    '51.91.76.89',
    '52.73.70.149',
    '5.34.74.210',
    '54.191.98.150',
    '54.37.106.167',
    '54.38.143.246',
    '59.4.68.75',
    '62.64.9.237',
    '62.99.79.77',
    '65.152.201.203',
    '66.113.160.126',
    '66.175.217.172',
    '67.213.75.205',
    '68.183.216.174',
    '72.249.22.245',
    '74.63.218.139',
    '75.176.235.182',
    '78.47.139.43',
    '79.106.115.107',
    '79.143.186.143',
    '79.172.201.113',
    '80.241.218.90',
    '81.0.236.93',
    '85.187.234.15',
    '85.88.174.94',
    '87.97.178.92',
    '87.98.128.76',
    '88.150.240.129',
    '88.87.15.96',
    '89.37.1.2',
    '91.191.172.124',
    '91.207.28.33',
    '91.235.129.8',
    '91.83.88.122',
    '92.38.128.47',
    '94.177.176.51',
    '94.183.237.101',
    '94.23.86.141',
    '94.247.168.64',
    '94.28.78.200',
    '94.74.133.76',
    '95.111.235.8',
    '95.138.161.226',
    '96.9.77.56',
    '97.107.127.161',
    '97.83.40.67'
  }
  def addressInNetwork(ip, net):
    import socket,struct
    ipaddr = int(''.join([ '%02x' % int(x) for x in ip.split('.') ]), 16)
    netstr, bits = net.split('/')
    netaddr = int(''.join([ '%02x' % int(x) for x in netstr.split('.') ]), 16)
    mask = (0xffffffff << (32 - int(bits))) & 0xffffffff
    return (ipaddr & mask) == (netaddr & mask)
  def evaluate(results):
    findings = []
    for sg in results:
      configuration = json.loads(sg['configuration'].getValue())
      for egress in configuration['ipPermissionsEgress']:
        for ip_range in egress['ipRanges']:
          cidr = ip_range['cidrIp']
          for ip in cnc_ips:
            if addressInNetwork(ip, cidr):
              findings.append({'arn': sg['arn']})
              break
    return findings
remediation: >
  In the AWS Management Console, go to EC2->Security Groups. For each group found by this rule:
  1) Select the given rule
  2) Choose the 'Outbound Rules' tab
  3) Click 'Edit outbound rules'
  4) Edit any CIDR / IP addresses and minimize the permitted scope to just the minimum required for connectivity.
remediationDocURLs:
version: 0.1.0