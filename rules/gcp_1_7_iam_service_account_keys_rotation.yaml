id: 0574e261-eb42-4286-8158-fdc6e392ed9d
ruleId: gcp_004
type: asset
ruleName: >
  Ensure user-managed/external keys for service accounts are rotated every 90 days or less
description: >
  Service Account keys consist of a key ID (Private_key_Id) and Private key, which are used to sign programmatic
  requests users make to Google cloud services accessible to that particular service account.
  It is recommended that all Service Account keys are regularly rotated.
severity: high
enabled: true
sql: >
  SELECT keys ->> 'name' as asset_id
    FROM assets acc,
    LATERAL (
        SELECT value AS keys
        FROM jsonb_array_elements(supplementary_configuration -> 'keys' -> 'keys')
    ) arr
  WHERE acc.resource_type = 'GCP::Iam::ServiceAccount'
  AND to_timestamp(arr.keys ->> 'validAfterTime', 'YYYY-MM-DDTHH:MI:SSZ') < now() - interval '90 Days'
remediation: >
  From Console
    1. Go to APIs & Services\Credentials using https://console.cloud.google.com/apis/credentials
    2. In the Section Service Account Keys,
  for every external (user-managed) service account key where creation date is greater than or equal to the past 90 days,
  click Delete Bin Icon to Delete Service Account key
    3. Create a new external(user-managed) Service Account key for a Service Account
remediationDocURLs:
version: 1.0
