id: 3111574f-4af8-4fac-bd68-839f9f8d6477
ruleId: gcp_002
type: asset
ruleName: >
  Ensure that IAM users are not assigned the Service Account User or
  Service Account Token Creator roles at project level
description: >
  It is recommended to assign the Service Account User (iam.serviceAccountUser) and
  Service Account Token Creator (iam.serviceAccountTokenCreator) roles to a user for
  a specific service account rather than assigning the role to a user at project level
severity: high
enabled: true
sql: >
  SELECT CONCAT(binding->>'role_', ' exists in ', asset_id) AS asset_id
  FROM
    (SELECT asset_id,
            jsonb_array_elements(supplementary_configuration->'iamPolicy'->'bindings_') AS binding
       FROM assets
      WHERE resource_type = 'GCP::ResourceManager::Project') AS bindings
  WHERE binding->>'role_' = 'roles/iam.serviceAccountTokenCreator'
    OR binding->>'role_' = 'roles/iam.serviceAccountUser'
remediation: >
  From Console:
    1. Go to the IAM page in the GCP Console by visiting:
    https://console.cloud.google.com/iam-admin/iam.
    2. Click on the filter table text bar. Type Role: Service Account User
    3. Click the Delete Bin icon in front of the role Service Account User for every user
    listed as a result of a filter.
    4. Click on the filter table text bar. Type Role: Service Account Token Creator
    5. Click the Delete Bin icon in front of the role Service Account Token Creator for
    every user listed as a result of a filter.
  From Command Line:
    1. Using a text editor, remove the bindings with the roles/iam.serviceAccountUser
    or roles/iam.serviceAccountTokenCreator.

    For example, you can use the iam.json file shown below as follows:
      {
      "bindings": [
      {
       "members": [
       "serviceAccount:our-project-123@appspot.gserviceaccount.com",
       ],
       "role": "roles/appengine.appViewer"
      },
      {
       "members": [
       "user:email1@gmail.com"
       ],
       "role": "roles/owner"
       },
      {
       "members": [
       "serviceAccount:our-project-123@appspot.gserviceaccount.com",
       "serviceAccount:123456789012-compute@developer.gserviceaccount.com"
       ],
       "role": "roles/editor"
      }
      ],
      "etag": "BwUjMhCsNvY="
       }
    2. Update the project's IAM policy:
    gcloud projects set-iam-policy PROJECT_ID iam.json
# remediationDocURLs:
# - https://docs.openraven.com/remediations/unassing_gcp_Service_Account_User_and_Service_Account_Token_Creator_roles_from_project_level
version: 0.1.3
