# id: f85e9abc-60a8-4a03-a7df-ca283cfa7490
ruleId: aws-management-tools-cloudtrail-vpc-changes
type: asset
ruleName: >
  Ensure a log metric filter and alarm exist for VPC changes
description: >
  Real-time monitoring of API calls can be achieved by directing CloudTrail Logs to
  CloudWatch Logs and establishing corresponding metric filters and alarms. It is possible to
  have more than 1 VPC within an account, in addition it is also possible to create a peer
  connection between 2 VPCs enabling network traffic to route between VPCs. It is
  recommended that a metric filter and alarm be established for changes made to VPCs.
severity: high
enabled: true
sql: >
  WITH
  get_group_names AS (
    SELECT log_group_name
     FROM
      (SELECT arn,
          jsonb_array_elements(supplementaryconfiguration->'eventSelectors'->'eventSelectors') AS event_selector,
          regexp_replace(regexp_replace(supplementaryconfiguration->'trailDetails'->'trail'->>'cloudWatchLogsLogGroupArn', '.*log-group:', ''), ':\*', '') AS log_group_name
      FROM ${magpie_schema}.awscloudtrailtrail
      WHERE resourcetype = 'AWS::CloudTrail::Trail' AND supplementaryconfiguration->'trailDetails'->'trail'->'isMultiRegionTrail' = 'true' AND supplementaryconfiguration->'status'->'isLogging' = 'true') get_log_group_name_table
    WHERE event_selector->'includeManagementEvents' = 'true' AND event_selector->>'readWriteType' = 'All'
  ),
  get_metric_filters AS (
    SELECT jsonb_array_elements(configuration->'metricTransformations') AS metric
    FROM ${magpie_schema}.awswatchlogsmetricfilter AS metric_filters, get_group_names
    WHERE metric_filters.resourcetype = 'AWS::CloudWatchLogs::MetricFilter' AND metric_filters.configuration->>'logGroupName' = get_group_names.log_group_name
      AND regexp_replace(metric_filters.configuration->>'filterPattern', '\s', '', 'g') LIKE regexp_replace('%' || ' ($.eventName = CreateVpc) || ($.eventName = DeleteVpc) || ($.eventName = ModifyVpcAttribute) ||
                                                                                                      ($.eventName = AcceptVpcPeeringConnection) || ($.eventName = CreateVpcPeeringConnection) ||
                                                                                                      ($.eventName = DeleteVpcPeeringConnection) || ($.eventName = RejectVpcPeeringConnection) ||
                                                                                                      ($.eventName = AttachClassicLinkVpc) || ($.eventName = DetachClassicLinkVpc) ||
                                                                                                      ($.eventName = DisableVpcClassicLink) || ($.eventName = EnableVpcClassicLink) ' || '%', '\s', '', 'g')
  ),
  get_alarm_topic AS (
    SELECT regexp_replace(jsonb_array_elements_text(configuration->'alarmActions'), '\"', '', 'g') AS topic_arn
    FROM ${magpie_schema}.awswatchalarm AS alarms, get_metric_filters
    WHERE alarms.resourcetype = 'AWS::CloudWatch::Alarm' AND alarms.configuration->>'metricName' = get_metric_filters.metric->>'metricName'
  ),
  get_topic_subscribers_confirmed AS (
    SELECT awssnstopic.configuration->'attributes'->>'SubscriptionsConfirmed' AS subscribers_number
    FROM get_alarm_topic, ${magpie_schema}.awssnstopic AS awssnstopic
    WHERE awssnstopic.resourcetype='AWS::SNS::Topic' AND get_alarm_topic.topic_arn = awssnstopic.arn
  )

  SELECT 'No log metric filter and alarm exist for VPC changes' AS arn
  WHERE NOT EXISTS
      (SELECT *
       FROM get_group_names)
    OR NOT EXISTS
      (SELECT *
       FROM get_metric_filters)
    OR EXISTS
      (SELECT *
       FROM get_topic_subscribers_confirmed
       WHERE subscribers_number = '0');

remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 0.9
